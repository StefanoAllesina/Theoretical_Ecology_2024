# Models for a single population

```{r}
#| warning: false
#| message: false
#| echo: false
library(tidyverse) # plotting, data organization
library(deSolve) # integrate differential equations
```

## A simple model for non-overlapping generations

Consider a population reproducing annually, with non-overlapping generations. Over its lifetime, each individual produces $\rho$ offspring, which form the next generation. Then, we can write:

$$
x_{k+1} = \rho x_k
$$

where $x_k$ is the number of individuals/area at generation $k$. Naturally, we can iterate again, and find the population density at time $x_{k+2}$:

$$
x_{k+2} = \rho x_{k+1} = \rho^2 x_{k}
$$ 

and in general:

$$
x_{n} = \rho^n x_0
$$

where $x_0$ is the initial population size, and $n$ is the number of generations since we started tracking the population. We assume $x_0>0$, and thus the population grows whenever $\rho > 1$, declines whenever $\rho < 1$, and is constant whenever $\rho = 1$. Armed with $x_0$ and $\rho$ we can project the population forward in time for an arbitrary number of generations. 

## Overlapping generations: exponential growth

Take the population density at time $t$ and $t + \Delta t$; in the time interval $\Delta t$ the change in population density is $x(t + \Delta t) - x(t)$, and the average change per unit of time is $(x(t + \Delta t) - x(t))/\Delta t$. We can consider the limit in which the interval $\Delta t$ shrinks to zero:

$$
\lim_{\Delta t \to 0} \dfrac{x(t + \Delta t) - x(t)}{\Delta t} = \frac{dx(t)}{dt}
$$

In fact, this is exactly the definition of the derivative with respect to (w.r.t.) time of the function $x(t)$. A great contribution of Newton and Leibniz was to recognize that many natural phenomena can be described by simple differential equations---even though the equations describing the rate of change $dx(t)/dt$ are simple, the behavior of the solutions $x(t)$ can be incredibly complex.

In ecology and evolutionary biology, one encounters two main types of differential equations:

- *Ordinary differential equations* (ODEs) describe the rate of change of a quantity (in our case, population densities, $x(t)$) as a function of an independent variable (in our case, the time $t$), and can contain functions of the quantity, and its derivatives. If only the first derivative ($dx(t)/dt$) is included, they are called first-order ODEs. 

- *Partial differential equations* (PDEs) contain more than one independent variable (e.g., time and coordinates in space). Therefore, the quantity of interest is a multivariate function, such as $q(x,y,t)$, denoting the density of a population at the coordinates $x,y$ and time $t$. The partial derivatives with respect to the independent variables are considered, hence the name.

Many other types of differential equations (stochastic differential equations, SDEs; integro-differential equations, IDEs; etc.) are found in certain technical areas.

In this class, we will deal exclusively with ODEs of the form:

$$
\dfrac{dx(t)}{dt} = f(x(t))
$$

where the function $f(x(t))$ models different ecological phenomena influencing the growth and decline of populations. For example, take populations growing thanks to the per-capita birth rate $\beta$, and declining due to the death rate $\delta$:

$$
\dfrac{dx(t)}{dt} = \beta x(t) - \delta x(t) = (\beta - \delta) x(t) = \rho\, x(t)
$$

here the *intrinsic growth rate* $\rho$ represents the difference between birth and death rates. The parameter is taken to be independent of time, yielding an *autonomous* differential equation. An ODE is autonomous if it does not depend explicitly on the independent variable (in our case, time). I.e., if $dx/dt = f(x(t))$ the system is autonomous, while $dx/dt = g(x(t),t)$ is not.

::: {.callout-note collapse="true"}
## Separation of variables

A differential equation for $x(t)$ is called separable, if it can be written as:

$$
\frac{dx(t)}{dt} = g(t)\, h(x(t))
$$

where $g(t)$ is a function of $t$, and $h(x(t))$ a function of $x(t)$. As long as $h(x(t)) \neq 0$, we can formally write:

$$
\frac{1}{h(x(t))} dx(t) = g(t)\, dt
$$

We can now integrate both sides, obtaining 

$$
\begin{aligned}
\int \frac{1}{h(x(t))} dx(t) + \mathcal c_1 &= \int g(t)\, dt + \mathcal c_2\\
\int \frac{1}{h(x(t))} dx(t) &= \int g(t)\, dt + \mathcal c
\end{aligned}
$$

where $\mathcal c_1, \mathcal c_2$ and $\mathcal  c = \mathcal c_2 - \mathcal c_1$ are constants of integration, whose value can be set by considering the initial conditions. 

**Example** 

Consider:

$$
\frac{dx(t)}{dt} = \alpha
$$

with initial condition $x(0) = x_0$. Separate the variables and integrate:

$$
\begin{aligned}
d x(t) &= \alpha\, dt\\
\int d x(t) &= \alpha \int dt + \mathcal c\\
x(t) &= \alpha t + \mathcal c
\end{aligned}
$$

Now substitute the initial condition:

$$
x(0) = x_0 = \alpha 0 + c  = c
$$

Yielding the solution:

$$
x(t) = x_0 + \alpha t
$$

A solution of an *initial-value* problem is an equation which, given the values of the parameters ($\alpha$, in this case) and the initial conditions ($x_0$, in this case), allows us to determine the value of the dependent variable ($x(t)$) for any value of the independent variable ($t$). Only relatively simple ODEs or systems of ODEs can be solved explicitly.
:::

We can solve the differential equation:

$$
\begin{aligned}
\dfrac{dx}{dt} &= \rho\, x\\
\dfrac{1}{x}\,dx &= \rho\, dt
\end{aligned}
$$

Integrate both sides

$$
\begin{aligned}
\int \dfrac{1}{x}\,dx &= \int \rho\, dt\\
\log x &= \rho\, t + \mathcal c\\
x &= e^{\rho\, t  + \mathcal c}\\
x &= e^{\rho\, t} e^\mathcal c\\
\end{aligned}
$$

where $\mathcal c$ is a constant of integration. Then, we can plug in the initial condition: at $t=0$, the population is at density $x_0$:

$$
\begin{aligned}
x_0 &= e^{\rho\, 0}e^{\mathcal c}\\
x_0 &= e^\mathcal c
\end{aligned}
$$

We obtain the solution:

$$
x(t) = x(0) e^{\rho\, t}
$$

::: {.callout-tip collapse="true"}
## Integrating differential equations numerically

You can compute $x(t)$ for any differential equation (or system of differential equations) in `R` using numerical techniques. Your code needs to include two parts:

First, we write a function defining the (system of) ODE(s). This function takes three arguments: `t`, the time, `x`, the state of the system, and `parms`, a list of parameters, and returns a `list` containing $dx/dt$. For the exponential growth, we can write:

```{r}
exponential_growth <- function(t, x, parms){
  dxdt <- x * parms$rho
  return(list(dxdt))
}
```

Because ecological models only make sense for positive population densities, we can set an arbitrarily small threshold, and consider the population extinct if it falls below the threshold:

```{r}
THRESH <- 10^-10

exponential_growth <- function(t, x, parms){
  if(x < THRESH) x <- 0
  dxdt <- x * parms$rho
  return(list(dxdt))
}
```

The second part of the code invokes the numerical integration function `ode`. For this function, we need to set a) initial conditions, b) determine at which times do we want to observe the state of the population, c) specify the name of the function to use, d) the parameters to use, and e) (optional) specify the method to use for the integration. The function `ode` is part of the package `deSolve`:

```{r}
x0 <- 1 # initial conditions
my_time <- seq(0, 5, by = 0.1) # we will observe the system at these times
parms <- list(rho = 1.05) # list of parameters
output <- ode(y = x0, # a) initial conditions
             times = my_time,  # b) time at which we observe the system
             func = exponential_growth, # c) function computing r.h.s. of ODEs
             parms = parms, # d) parameters of ODEs
             method = "ode45") # e) more on this later; this is a good general-purpose choice
```

The output is a matrix of class `deSolve`, containing the time in the first column, and the values of $x(t)$ in the second. For plotting, it is best to convert this into a data frame:

```{r}
output %>% 
  as.data.frame() %>% 
  ggplot() + aes(x = time, y = `1`) + 
  geom_point() + 
  geom_line() + 
  xlab("t") + 
  ylab(expression(x(t))) + 
  theme_bw()
```
:::

### Doubling time

How long will it take for a growing population ($\rho > 0$) to double in density? We are looking for $\tau$ such that 
$$
\begin{aligned}
x(\tau) &= 2 x_0\\
x_0 e^{\rho \tau} &= 2 x_0\\
e^{\rho \tau} &= 2\\
\rho \tau &= \log 2\\
\tau &= \dfrac{\log 2}{\rho}
\end{aligned}
$$

Thus, the doubling time does not depend on the initial condition: the population will keep doubling every $\log 2 / \rho$ units of time. For example, take $\rho = 0.01$, then $\tau \approx 30$: a population growing exponentially with rate of 1% per year will double every 30 years or so. Then, a growth of 3% doubles every 10 years, etc. 

::: {.callout-warning collapse="true"}
## Exercise: Radiocarbon dating

While at the University of Chicago, Willard Libby (Nobel Laureate in Chemistry, 1960) pioneered radiocarbon dating. The carbon isotope ${}^{14}$C is constantly being created in the Earth's atmosphere by the interaction of cosmic rays with atmospheric nitrogen. The carbon combines with oxygen, to form CO${}_2$ that is then absorbed by plants. When plants die, the isotope decays in their tissues. Radioactive decay follows the exponential model:

$$
N(t) = e^{\lambda t} N(0)
$$

where $\lambda < 0$ is the decay rate of the isotope. The half-life of a radioisotope is the time it takes to be reduced to half of the original concentration, and is 5,730 years for ${}^{14}$C. 

- Find the value of $\lambda$ given the half-life
- Express $t$ as a function of $\lambda$, and the ratio between $N(t)$ and $N(0)$
- The concentration in the atmosphere is about 1 atom of ${}^{14}$C for every $10^{12}$ atoms of carbon. You have a collected sample that contains $1/16$ atoms of ${}^{14}$C for every $10^{12}$ atoms of carbon; date the sample.
:::

## Logistic equation

We have a population that grows exponentially when at very low densities, but experience a slow down in growth when densities are higher. The logistic growth equation is typically written as:

$$
\frac{d X}{d \tau} = X\left(\rho - \alpha X\right)
$$

where $\rho>0$ is the intrinsic growth rate of the population, and $\alpha>0$ is a parameter that regulates the amount by which growth is decreased as $X$ increases. 

An equilibrium (steady-state, fixed point) of a differential equation is a value of the dependent variable ($X$) that makes the right-hand side of the equation zero. We denote an equilibrium as $X^\star$. We can write:

$$
\left.\dfrac{dX}{d\tau}\right|_{X^\star} = 0
$$

i.e., the differential equation, evaluated at the point $X^\star$ is zero: the population will not grow nor decline, but rather will remain at $X^\star$. The logistic equation has two equilibria: $X=0$ (absence of the population), and $\rho = \alpha X$, $X = \rho / \alpha = \kappa$, called the carrying capacity of the population.

::: {.callout-note collapse="true"}
## Chain rule

This is one of the most useful formulas from calculus. It relates the derivative of the composition of two differentiable functions with the derivatives of the functions. If $h(x) = g(u)$ and $u = f(x)$, then:

$$
\dfrac{dh}{dx} = \dfrac{dg}{du}\dfrac{du}{dx}
$$

As put by George Simmons [Calculus with Analytic Geometry (1985)]: *If a car travels twice as fast as a bicycle and the bicycle is four times as fast as a walking man, then the car travels 2 × 4 = 8 times as fast as the man.*

**Example**

Take 

$$
\dfrac{dx(t)}{dt} = x(t) f(x(t))
$$

and write the ODE describing $d \log x(t) /dt$. We can write this function as the derivative of the composition $\log x(t) = \log u$ and $u = x(t)$. Then, by chain rule:

$$
\begin{aligned}
\dfrac{d \log x(t)}{dt} &= \dfrac{d \log u}{du} \dfrac{du}{dt}\\
 &= \dfrac{1}{u} \dfrac{du}{dt}\\
 &= \dfrac{1}{x(t)} \dfrac{d x(t)}{dt}\\
 &= \dfrac{1}{x(t)}  x(t) f(x(t))\\
 &= f(x(t))
\end{aligned}
$$

showing that the per-capita rate of change:

$$
\dfrac{1}{x(t)} \dfrac{dx(t)}{dt} = \dfrac{\log x(t)}{dt}
$$

is the derivative in time of the logarithm of the density of the population.
:::

We can simplify the analysis of the differential equation by rescaling all the variables by positive quantities, thus obtaining a simpler form that retains the behavior of the original equation.

::: {.callout-note collapse="true"}
## Nondimensionalization

Ecological models can have many parameters, and the goal of nondimensionalization is to rewrite the equations using as few parameters as possible, via a change of variables. Importantly, the new system and the original one are equivalent, and share the same dynamics. In fact, the trajectories of the original system can be reconstructed from those of the simpler system by inverting the transformation. 

To perform nondimensionalization:

- identify all the variables that depend on time ($X(\tau)$, $Y(\tau)$, etc.), as well as the independent variable (the time, $\tau$)
- replace each of them by a scaled version: $X = c_x x$, $Y = c_y y$, $t = c_t \tau$, in which $c_i$ are constants to be determined, and rewrite the equations for the new variables 
- choose the values for the constants to eliminate as many parameters as possible. Generally, one should be able to remove one parameter for each dependent variable, plus one parameter by scaling the time. 

**Example**

The exponential growth equation has a single parameter:

$$
\frac{dx}{d\tau} = \rho x
$$

one can define $t = c_1 \tau$, obtaining:

$$
\begin{aligned}
\frac{1}{c_1}\frac{dx}{dt} &= \rho x\\
\frac{dx}{dt} &= c_1 \rho x\\
\frac{dx}{dt} &= x
\end{aligned}
$$

where we have chosen $c_1 = 1/\rho$.
:::

We rewrite the equation for the logistic growth by choosing $x = c_1 X$ and $t = c_2 \tau$. Our equations become (use the chain rule):

$$
\begin{aligned}
\dfrac{c_1}{c_2}\dfrac{dx}{dt} &= c_1 x (\rho - \alpha c_1 x)\\
\dfrac{dx}{dt} &= x (\rho c_2 - \alpha c_1 c_2 x)\\
\end{aligned}
$$
We choose $c_2 = 1/\rho$ to make the first coefficient in parenthesis be equal to 1; then, we choose $c_1 = \rho/\alpha$ to make the second coefficient be 1:

$$
\dfrac{dx}{dt} = x (1 - x)
$$

Note that in practice we have chosen to rescale the variables using the intrinsic growth rate, $t = \tau / \rho$, and the carrying capacity, $x = X \alpha / \rho = X / \kappa$.

The logistic equation can be solved, because it is separable:

$$
\begin{aligned}
\dfrac{1}{x(1-x)} dx &= dt\\
\left(\dfrac{1}{x}-\dfrac{1}{x-1}\right)dx &= dt\\
\int \dfrac{1}{x} dx - \int \dfrac{1}{1-x} dx &= \int dt + \mathcal c\\
\log x - \log(x-1)&= t + c\\
\log \dfrac{x}{x-1}&= t + c\\
\dfrac{x}{x-1} &= e^t e^c\\
x &= \dfrac{e^t e^c}{e^t e^c - 1}\\
x &= \dfrac{1}{1 - e^{-t}e^{-c}}
\end{aligned}
$$

Plugging in $x_0$ when $t=0$, we find the value for the constant of proportionality:

$$
\begin{aligned}
x_0 &= \frac{e^c}{e^c - 1}\\
e^c &= \frac{x_0}{x_0 - 1}
\end{aligned}
$$

Yielding the solution

$$
x(t) = \dfrac{x_0 e^t}{1 + (e^t - 1)x_0}
$$




::: {.callout-warning collapse="true"}
## Exercise 1

Take the equation for the logistic growth:

$$
\frac{dx}{dt} = x(1-x)
$$

- Solve the logistic growth model (the equation is separable). 
- Determine the location of all equilibria and their stability. 
- Write code to integrate the equation numerically.
- What happens if $x(0) > 1$, $x(0) = 1$, $0 < x(0) < 1$?
- (Bonus question) write a Lyapunov function for the logistic equation, and prove the global stability of the positive equilibrium.

:::
