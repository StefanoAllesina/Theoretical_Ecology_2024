# Models for two populations
```{r}
#| warning: false
#| message: false
#| echo: false
library(tidyverse) # plotting, data organization
library(deSolve) # integrate differential equations
```


```{r}
THRESH <- 10^-10
glv_dxdt <- function(x, parms) x * (parms$r + as.vector(parms$A %*% x))

glv_2 <- function(t, x, parms){
  x[x < THRESH] <- 0
  dxdt <- glv_dxdt(x, parms)
  return(list(dxdt))
}

# one-size-fits all plots for 2-spp GLV

parms <- list(r = rnorm(2), A = matrix(rnorm(4), 2, 2))


glv2_plot_all <- function(parms, 
                          xlims = c(0, 2), 
                          ylims = c(0,2),
                          num_arrows = 20,
                          arrow_length = 0.1){
  A <- parms$A
  r <- parms$r
  # find equilibria
  # 1) trivial
  xs <- tibble(x = 0, y = 0)
  # 2) marginal
  if ((A[1,1] != 0) & (-r[1] / A[1,1] > 0)) xs <- bind_rows(xs, tibble(x = -r[1] / A[1,1], y = 0))
  if ((A[2,2]) & (-r[2] / A[2,2] > 0)) xs <- bind_rows(xs, tibble(y = -r[2] / A[2,2], x = 0))
  # 3) coexistence
  tmp <- as.vector(solve(A, -r))
  if(all(tmp > 0)) xs <- bind_rows(xs, tibble(x = tmp[1], y = tmp[2]))
  # now compute their local stability
  is_stable <- function(z, r, A){
    M <- matrix(c(
      r[1] + 2 * A[1,1] * z[1] + A[1,2] * z[2], A[1,2] * z[1], 
      A[2,1] * z[2], r[2] + 2 * A[2,2] * z[2] + A[2,1] * z[1]
    ), 2, 2, byrow = TRUE)
    st <- max(Re(eigen(M, only.values = TRUE)$values))
    if (st < 10^-10) return(TRUE)
    return(FALSE)
  }
  xs <- xs %>% add_column(stable = apply(xs, 1, is_stable, A = A, r = r))
  pl <- ggplot(data = xs) + aes(x = x, y = y) + geom_point(aes(shape = stable), size = 2) + 
  xlim(xlims * max(0.01, max(xs[,1]))) + ylim(ylims * max(0.01, max(xs[,2])))
  # compute isoclines
  intercepts <- c(-r[1] / A[1,2], -r[2] / A[2,2])
  slopes <- c(-A[1,1] / A[1,2], -A[2,1] / A[2,2])
  if(A[2,2] == 0) intercepts[2] <- -r[2] / a[2,1]
  pl <- pl + geom_abline(slope = slopes[1], intercept = intercepts[1], linetype = 2)
  if (!is.infinite(slopes[2])) {
    pl <- pl + geom_abline(slope = slopes[2], intercept = intercepts[2], linetype = 2)
  } else {
    pl <- pl + geom_vline(xintercept = intercepts[2])
  }
  # flow
  xx <- seq(0.001, xlims[2] * max(0.01, max(xs[,1])), length.out = num_arrows)
  yy <- seq(0.001, ylims[2] * max(0.01, max(xs[,2])), length.out = num_arrows)
  tb_flow <- expand_grid(xx, yy)
  colnames(tb_flow) <- c("x", "y")
  # compute dxdt
  tb_flow2 <- t(apply(tb_flow, 1, glv_dxdt, parms = parms))
  colnames(tb_flow2) <- c("xend", "yend")
  tb_flow2 <- tb_flow2 %>% as_tibble() %>% mutate(col_arrow = paste(sign(xend), sign(yend)))
  tb_flow <- bind_cols(tb_flow, tb_flow2) %>% mutate(xend = x + xend * arrow_length, 
                                                     yend = y + yend * arrow_length)
  
  pl <- pl + geom_segment(data = tb_flow, 
                    aes(xend = xend, yend = yend, 
                        colour = col_arrow, 
                        x = x, y = y), arrow = arrow(length = unit(0.01, "npc")))
  pl <- pl + theme_bw() + theme(legend.position = "none")
  show(pl)
}
```



## Lotka-Volterra predator-prey model

We have a prey who would grow exponentially when the predator is absent, and a predator that would decline exponentially when the prey is absent. The two species interact, thus allowing for their coexistence:

$$
\begin{cases}
\dfrac{dX}{d\tau} = \rho X - \alpha X Y = X(\rho - \alpha Y)\\
\dfrac{dY}{d\tau} = -\delta Y + \beta X Y = Y(-\delta + \beta X)
\end{cases}
$$

where all parameters are positive. There are two equilibria: $(X, Y) = (0, 0)$ and $(X, Y) = \left(\frac{\delta}{\beta}, \frac{\rho}{\alpha} \right)$.

**Nondimensionalization** To simplify the equation (but maintain all its important features), we can define two new variables and a new time scale:

$$
x = c_1 X \quad y = c_2 Y \quad t = c_3 \tau
$$

Using the new variables, we write:

$$
\begin{cases}
\dfrac{c_1}{c_3}\dfrac{dx}{dt} = c_1 x(\rho - \alpha c_2 y)\\
\dfrac{c_2}{c_3}\dfrac{dy}{dt} = c_2 y(-\delta + \beta c_1 x)
\end{cases}
$$
and thus

$$
\begin{cases}
\dfrac{dx}{dt} = x(c_3 \rho - \alpha c_2 c_3 y)\\
\dfrac{dy}{dt} = y(-c_3 \delta + \beta c_1 c_3 x)
\end{cases}
$$

It is convenient to take $c_3 = 1/\rho$, $c_2 = \rho / \alpha$, and $c_1 = \rho / \beta$, thus simplifying the system to:

$$
\begin{cases}
\dfrac{dx}{dt} = x(1 - y)\\
\dfrac{dy}{dt} = y(-\frac{\delta}{\rho} + x) = y(-\alpha + x)
\end{cases}
$$

We can therefore analyze the case in which we have only a single free parameter, $\alpha = \rho / \delta > 0$. The equilibria are $(x,y) = (0,0)$ and $(x, y) = (\alpha, 1)$.

**Isoclines of net zero growth**. Clearly, the first equation is zero when either the prey is absent, or the predator is at $y = 1$; the second equation is zero when either the predator is absent or the prey is at $x = \alpha$; we can draw the two lines in a plane where we have $x$ on the x-axis and $y$ on the y-axis. The feasible (positive) equilibrium will be at the intersection of the two lines:

```{r}
#| echo: false
alpha <- 0.5
pl <- ggplot(data = tibble(x = alpha, y = 1)) + 
              aes(x = x, y = y) + 
              xlim(c(0,1)) + 
              ylim(c(0,2)) 
pl <- ggplot_part_isoclines(pl, h = 1, v = alpha) + 
              geom_point() + 
              theme_bw() + 
              ggtitle("alpha=0.5")
show(pl)
```

**Direction of trajectories**

We have four quadrants surrounding the positive equilibrium:

- $x < \alpha, y < 1$: in the bottom-left corner, we have $dx/dt > 0$ and $dy/dt < 0$; accordingly, the prey will grow and the predator decline.

- $x > \alpha, y < 1$: in the bottom-right corner, we have $dx/dt > 0$ and $dy/dt > 0$; accordingly, both populations will grow

- $x > \alpha, y > 1$: in the top-right corner, we have $dx/dt < 0$ and $dy/dt > 0$; the prey will decline, the predator grow

- $x < \alpha, y > 1$: in the top-left corner, we have $dx/dt < 0$ and $dy/dt < 0$; both populations will decline

We can show these directions visually, by computing $(dx/dt, dy/dt)$ at different values of $(x, y)$:

```{r}
#| echo: false
xx <- seq(0.25, 1.75, by = 0.1) * alpha
yy <- seq(0.25, 1.75, by = 0.1) 
dt <- expand.grid(xx, yy)
dt <- as.data.frame(dt)
colnames(dt) <- c("x", "y")
dt <- dt %>% 
  mutate(dxdt = x * (1 - y), dydt = y * (-alpha  + x)) %>% 
  mutate(quadrant = as.factor((x < alpha) + 2 * (y < 1)))
ggplot(data = dt) + 
  geom_hline(yintercept = 1, linetype = 2)+ 
  geom_vline(xintercept = alpha, linetype = 2) + 
  aes(x = x, y = y, xend = x + 0.1 * dxdt, yend = y + 0.1 * dydt, color = quadrant) + 
  geom_segment(arrow = arrow(length = unit(0.01, "npc"))) + 
  geom_point(x = alpha, y = 1, color = "black") + 
  theme_bw() + theme(legend.position = "none")
```
































## Classic papers

Vito Volterra (1926)
Fluctuations in the Abundance of a Species Considered Mathematically
Nature 118 : 558-60

Gause, G.F. 1934. Experimental Analysis of Vito Volterra'S Mathematical Theory of the Struggle for Existence. Science 79:16-17

Chesson, P. 2000. Mechanisms of Maintenance of Species Diversity. Annual Review of Ecology and Systematics 31:343-366


May R.M. 1972. Will a large complex system be stable? Nature 238:413-414


Anderson, R.M; May, R.M. 1978. Regulation and Stability of Host-Parasite Population Interactions. Journal of Animal Ecology 47:219-247

May R.M. & Anderson, R.M. 1979. Population biology of infectious diseases: Part II. Nature 280:455-461


McCann, K.S. 2000. The diversity - stability debate. Nature 405:228-233
